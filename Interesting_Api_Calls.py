from idautils import *
from time import strftime

INTERESTING_SUBSTRINGS = [\
							("DeviceIoControl",       "Windbg"),\
							("IoGetCurrentProcess",       "Windbg"),\
							("IoCreateDevice",       "Windbg"),\
							("IoCreateSymbolicLink",       "Windbg"),\													
                        ]


if __name__ == '__main__':
    print("\n-------------------- Interesting Api Calls ------------------------------")
    print("Run at: %s" % (strftime("%Y-%m-%d %H:%M:%S")))
    for call_ea, name in sorted(Names()):
        demangled_name = Demangle(name, INF_SHORT_DN)
        if demangled_name != None:
            name = demangled_name

        for keyword, note in sorted(INTERESTING_SUBSTRINGS):
            if keyword.lower() in name.lower():
                xrefs = sorted([ x for x in CodeRefsTo(call_ea, 0) if SegName(call_ea) != ".data" ])
                if len(xrefs) > 0:
                    print("\nCalls To: (%x) %s (%s)" % (call_ea, name, note))
                    for xref in xrefs:
                        print("          [%x] %s" % (xref, GetFunctionName(xref)))
