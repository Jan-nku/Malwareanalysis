include ".\includes\IsPE.yar"
include ".\includes\SizeLimit.yar"
import "pe"

rule Lab1_1  
{
	strings:
	$string1 = "FindFirstFile" wide ascii
	$string2 = "FindNextFile" wide ascii
	$string3 = "CopyFile" wide ascii
	$string4 = "Sleep" nocase wide ascii
	$string5 = "C:\\windows\\system32\\kerne132.dll" nocase wide ascii
	$string6 = "C:\\*" wide ascii
	$string7 = "WARNING_THIS_WILL_DESTROY_YOUR_MACHINE" wide ascii
	$string8 = ".exe" wide ascii
	$a1 = "127.26.152.13" wide ascii
	$a2 = "exec" wide ascii
	$a3 = "Sleep" nocase wide ascii
	$a4 = "hello" nocase wide ascii
	
	condition:	
	IsPE and SizeLimit and 
	((6 of ($string*)) or (all of ($a*)))	//检测.exe和.dll
} 

rule Lab1_2
{
	strings:
	$string1 = { FF D5 8D 87 [4] 80 20 ?? 80 60 [2] 58 50 54 50 53 57 FF D5 58 61 8D 44 24 ?? 6A 00 39 C4 75 FA 83 EC 80 E9 }//UPX加壳特征
	$string2 = "InternetOpen" wide ascii
	$string3 = "VirtualProtect" wide ascii
	$string4 = "VirtualAlloc" wide ascii
	$a1 = "InternetOpenUrl" wide ascii
	$a2 = "CreateService" wide ascii
	$a3 = "Malservice" wide ascii
	$a4 = "http://www.malwareanalysisbook.com" wide ascii
	
	condition:	
	IsPE and SizeLimit 
	and ((all of ($string*)) or (all of ($a*)))//检测加壳前和加壳后
} 


rule Lab1_3
{
	strings:
	$a0 = { BB D0 01 40 00 BF 00 10 40 00 BE [4] 53 E8 0A 00 00 00 02 D2 75 05 8A 16 46 12 D2 C3 FC B2 80 A4 6A 02 5B }//FSG加壳特征

	condition:
	$a0 at pe.entry_point
}

rule Lab1_4
{
	strings:
	$string1 = "LoadResource" wide ascii
	$string2 = "FindResource" wide ascii
	$string3 = "SizeofResource" wide ascii
	$string4 = "WinExec" wide ascii
	$string5 = "\\system32\\wupdmgr.exe" wide ascii
	$string6 = "CreateFile" wide ascii
	$string7 = "WriteFile" wide ascii
	$a1 = "!This program cannot be run in DOS mode." wide ascii
	$a2 = {70 72 61 63 74 69 63 61 6C 6D 61 6C 77 61 72 65 61 6E 61 6C 79 73 69 73}//practicalmalwareanalysis
	$b = {4D 5A}

	condition:
	IsPE and SizeLimit 
	and (5 of ($string*)) 
	and (all of ($a*))
	and (#b > 1)
}
